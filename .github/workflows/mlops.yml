name: Radar MLOps Pipeline

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:

# ---------------- TEST ---------------- #

  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - run: pytest tests/ -v


# ---------------- TRAIN ---------------- #

  train:
    needs: test
    runs-on: ubuntu-latest   # change later to GPU runner
    timeout-minutes: 600     # VERY IMPORTANT (large training)

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install dagshub mlflow dvc
          pip install -r requirements.txt


# DOWNLOAD DATASET FROM DAGSHUB BUCKET

      - name: Configure DVC and pull dataset
        env:
          DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          pip install --upgrade pip
          pip install dvc

          # Configure DVC remote with credentials for this runner
          dvc remote modify origin --local auth basic || true
          dvc remote modify origin --local user "$DAGSHUB_USERNAME" || true
          dvc remote modify origin --local password "$DAGSHUB_TOKEN" || true

          # Pull dataset from DVC remote (origin)
          dvc pull data/raw -r origin || (echo "dvc pull failed" && exit 1)


#EXTRACT DATA

      - name: Extract dataset
        run: |
          tar -xf radar_dataset.tar
          ls data/raw | head


# ---------------- DVC DATA PUSH (for pipelines) ---------------- #

      - name: DVC Pull (get latest data)
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          pip install dvc
          dvc remote modify origin --local auth basic
          dvc remote modify origin --local user ${{ secrets.DAGSHUB_USERNAME }}
          dvc remote modify origin --local password ${{ secrets.DAGSHUB_TOKEN }}
          dvc pull data/raw -r origin || (echo "dvc pull failed" && exit 1)

# ---------------- OPTIONAL: UPLOAD DATA FOR UI ---------------- #

      - name: Upload data to DagsHub bucket (for UI)
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          pip install dagshub
          dagshub login --token $DAGSHUB_TOKEN
          dagshub upload \
            --bucket shashwatsingh0511/radae_mlops \
            data/raw

# TRAIN

      - name: Train Model
        env:
          ENABLE_MLFLOW: "true"
          DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          python radar_mlops.py


# UPLOAD MODEL BACK TO DAGSHUB

      - name: Upload trained model
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dagshub login --token $DAGSHUB_TOKEN
          dagshub upload \
            --bucket shashwatsingh0511/radae_mlops \
            data/processed models/
