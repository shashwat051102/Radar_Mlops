name: Radar MLOps Pipeline

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:

# ---------------- TEST ---------------- #

  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - run: pytest tests/ -v


# ---------------- TRAIN ---------------- #

  train:
    needs: test
    runs-on: ubuntu-latest   # change later to GPU runner
    timeout-minutes: 720     # 12 hours for enhanced training with EfficientNet-B3

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install dagshub mlflow dvc
          pip install -r requirements.txt


# DOWNLOAD DATASET FROM DAGSHUB BUCKET

      - name: Configure DVC and pull dataset
        env:
          DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          pip install --upgrade pip
          pip install dvc

          # Configure DVC remote with credentials for this runner
          dvc remote modify origin --local auth basic || true
          dvc remote modify origin --local user "$DAGSHUB_USERNAME" || true
          dvc remote modify origin --local password "$DAGSHUB_TOKEN" || true

          # Pull dataset from DVC remote (origin)
          dvc pull data/raw -r origin || (echo "dvc pull failed" && exit 1)


# (tar extraction removed â€” dataset is pulled via DVC)


# ---------------- DVC DATA PUSH (for pipelines) ---------------- #

      - name: DVC Pull (get latest data)
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          pip install dvc
          dvc remote modify origin --local auth basic
          dvc remote modify origin --local user ${{ secrets.DAGSHUB_USERNAME }}
          dvc remote modify origin --local password ${{ secrets.DAGSHUB_TOKEN }}
          dvc pull data/raw -r origin || (echo "dvc pull failed" && exit 1)

# ---------------- OPTIONAL: UPLOAD DATA FOR UI ---------------- #

      - name: Upload data to DagsHub bucket (for UI)
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          pip install dagshub
          dagshub login --token $DAGSHUB_TOKEN
          # Upload local folder `data/raw` to the repo `shashwatsingh0511/radae_mlops`
          # Usage: dagshub upload <owner/repo> <local-path> [target-path]
          dagshub upload shashwatsingh0511/radae_mlops data/raw data/raw || echo "dagshub upload failed"

# TRAIN

      - name: Train Model (Advanced Anti-Overfitting CI)
        env:
          ENABLE_MLFLOW: "true"
          DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
          # Advanced training with comprehensive anti-overfitting solutions
          EPOCHS: "10"              # Extended training for better convergence
          BATCH_SIZE: "8"          # Smaller for CI memory constraints
          IMAGE_SIZE: "224"        # Full resolution for quality
          BACKBONE: "efficientnet_b0"  # Balanced model complexity
          LEARNING_RATE: "3e-5"    # Reduced learning rate
          WEIGHT_DECAY: "0.08"     # Stronger regularization
          LABEL_SMOOTHING: "0.3"   # Enhanced label smoothing
          DROPOUT_RATE: "0.8"      # Maximum dropout
          NOISE_FACTOR: "0.3"      # Enhanced augmentation
          GRADIENT_CLIP: "1.0"     # Gradient clipping
          MIXUP_ALPHA: "0.4"       # Mixup augmentation
          SCHEDULER: "cosine"       # Learning rate scheduling
        run: |
          echo "ðŸš€ Starting ADVANCED anti-overfitting CI training..."
          echo "ðŸŽ¯ Solutions: Car class fix + Train-Val gap <15% + Validation >60%"
          echo "âš¡ Config: 10 epochs, Enhanced regularization, Mixup, Class balancing"
          python radar_mlops.py


# UPLOAD MODEL BACK TO DAGSHUB

      - name: Upload trained model
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dagshub login --token $DAGSHUB_TOKEN
          # Upload trained outputs to the repo under `models/`
          dagshub upload shashwatsingh0511/radae_mlops data/processed models || echo "dagshub upload failed"
